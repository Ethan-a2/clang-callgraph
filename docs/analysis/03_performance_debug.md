# 性能瓶颈分析与调试

## 潜在性能瓶颈
1. 解析阶段（Index.parse）：
   - 大型项目的 TU 构建耗时高，受 `-I`/`-D`/`-std` 参数与头文件数量影响。
   - 若 `compile_commands.json` 含大量文件，串行解析导致总体时间线性增长。
2. AST 遍历与构图：
   - `show_info` 对每个节点递归，若代码复杂/模板展开多，遍历节点数激增。
   - 过滤策略在调用表达式处才应用，可能在遍历时多做无效工作。
3. 输出阶段：
   - 深度优先打印调用链，若图存在大量边或近似完全图，输出量大；递归深度上限为 15 仍可能生成海量文本。
4. I/O 与诊断：
   - 打印每个文件名与诊断信息可能增加 I/O 时间。

## 调试与排查步骤
1. 基础确认：
   - 确认 Clang 与 Python 绑定版本匹配（如 clang==14.0.0 与系统 libclang）。
   - 使用 `--cfg` 提供正确的 `-I`、`-D`、`-std=` 参数，确保 TU 构建成功。
2. 诊断收集：
   - 观察 `tu.diagnostics` 输出：若有 Error/Fatal，记录并修正缺失头路径、宏定义或标准版本。
3. 性能定位：
   - 统计解析时间：在 `analyze_source_files` 中对 `Index.parse` 前后打点（可加入简单计时），识别耗时文件。
   - 控制输入规模：先对小子集或关键模块进行解析，验证算法行为与过滤效果。
4. 过滤优化：
   - 合理设置 `excluded_paths` 与 `excluded_prefixes`，如排除系统头与第三方库以减少遍历规模。
   - 将常用过滤策略写入 YAML 配置并复用。
5. 输出控制：
   - 使用 `--lookup` 或更精确名称，避免交互式全图探索导致巨大输出。
   - 若需要，后续可添加输出边界（如边数限制）或图导出为 DOT/JSON，交由其它工具渲染。
6. 环境与并行：
   - 在长期优化中考虑并行解析多个 TU（需确保 libclang 线程安全与资源隔离）。
   - 使用更快的存储介质（SSD）与更充足内存以降低解析瓶颈。
